import React, { useState, useMemo } from 'react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LineChart, Line, PieChart, Pie, Cell } from 'recharts';
import { Calculator, TrendingUp, Package, DollarSign, Users, Target } from 'lucide-react';

const ProductDashboard = () => {
  const [selectedProduct, setSelectedProduct] = useState('sos-perapan');
  const [productCost, setProductCost] = useState(3);
  const [affiliateRate, setAffiliateRate] = useState(15);
  const [dailyVolume, setDailyVolume] = useState(50);
  const [bundleType, setBundleType] = useState('single');

  const products = {
    'sos-perapan': { name: 'Sos Perapan', emoji: 'ü•´', defaultCost: 3.5 },
    'sos-black-pepper': { name: 'Sos Black Pepper', emoji: 'üñ§', defaultCost: 3.2 },
    'sos-cili': { name: 'Sos Cili', emoji: 'üå∂Ô∏è', defaultCost: 2.8 },
    'tepung-tempura': { name: 'Tepung Tempura', emoji: 'üç§', defaultCost: 2.5 },
    'tepung-waffle': { name: 'Tepung Waffle', emoji: 'üßá', defaultCost: 3.0 }
  };

  const calculateProfits = useMemo(() => {
    const basePrice = 10;
    const tikTokCommission = basePrice * 0.02;
    const paymentProcessing = basePrice * 0.025;
    const serviceFee = 0.30;
    const totalFees = tikTokCommission + paymentProcessing + serviceFee;
    const affiliateCommission = (affiliateRate / 100) * basePrice;
    
    const bundles = {
      single: { units: 1, revenue: basePrice, fees: totalFees },
      pack3: { units: 3, revenue: basePrice * 3, fees: 1.65 },
      pack5: { units: 5, revenue: basePrice * 5, fees: 2.55 }
    };
    
    const bundle = bundles[bundleType];
    const netRevenue = bundle.revenue - bundle.fees - (affiliateCommission * bundle.units);
    const totalProductCost = productCost * bundle.units;
    const profit = netRevenue - totalProductCost;
    const profitPerUnit = profit / bundle.units;
    const marginPercent = (profit / bundle.revenue) * 100;
    
    return {
      revenue: bundle.revenue,
      fees: bundle.fees,
      affiliate: affiliateCommission * bundle.units,
      productCost: totalProductCost,
      profit,
      profitPerUnit,
      marginPercent,
      units: bundle.units
    };
  }, [productCost, affiliateRate, bundleType]);

  const volumeProjections = useMemo(() => {
    const daily = calculateProfits.profit * dailyVolume;
    const monthly = daily * 30;
    const annual = monthly * 12;
    const unitsDaily = dailyVolume * calculateProfits.units;
    const unitsMonthly = unitsDaily * 30;
    const unitsAnnual = unitsMonthly * 12;
    
    return {
      daily: { profit: daily, units: unitsDaily },
      monthly: { profit: monthly, units: unitsMonthly },
      annual: { profit: annual, units: unitsAnnual }
    };
  }, [calculateProfits, dailyVolume]);

  const chartData = Object.keys(products).map(key => {
    const product = products[key];
    const tempCost = product.defaultCost;
    const netRevenue = 10 - 0.75 - (affiliateRate / 100 * 10);
    const profit = netRevenue - tempCost;
    const margin = (profit / 10) * 100;
    
    return {
      name: product.name,
      profit: profit.toFixed(2),
      margin: margin.toFixed(1),
      cost: tempCost
    };
  });

  const pieData = [
    { name: 'Profit', value: calculateProfits.profit, color: '#10B981' },
    { name: 'Product Cost', value: calculateProfits.productCost, color: '#F59E0B' },
    { name: 'TikTok Fees', value: calculateProfits.fees, color: '#EF4444' },
    { name: 'Affiliate', value: calculateProfits.affiliate, color: '#8B5CF6' }
  ];

  const COLORS = ['#10B981', '#F59E0B', '#EF4444', '#8B5CF6'];

  return (
    <div className="min-h-screen bg-gray-50 p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="mb-8">
          <h1 className="text-3xl font-bold text-gray-900 mb-2">
            üìä Dashboard Profit Analysis - Produk Sos & Tepung
          </h1>
          <p className="text-gray-600">Harga Jual Fixed RM10 | Customer Bayar Shipping</p>
        </div>

        {/* Controls */}
        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
          <h2 className="text-xl font-semibold mb-4">‚öôÔ∏è Pengaturan Analisis</h2>
          
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Produk</label>
              <select 
                value={selectedProduct} 
                onChange={(e) => {
                  setSelectedProduct(e.target.value);
                  setProductCost(products[e.target.value].defaultCost);
                }}
                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              >
                {Object.entries(products).map(([key, product]) => (
                  <option key={key} value={key}>
                    {product.emoji} {product.name}
                  </option>
                ))}
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Kos Produk (RM)</label>
              <input
                type="number"
                step="0.1"
                value={productCost}
                onChange={(e) => setProductCost(parseFloat(e.target.value) || 0)}
                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Affiliate (%)</label>
              <select 
                value={affiliateRate} 
                onChange={(e) => setAffiliateRate(parseInt(e.target.value))}
                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              >
                <option value={0}>0% - No Affiliate</option>
                <option value={10}>10% - Standard</option>
                <option value={15}>15% - Premium</option>
                <option value={20}>20% - High Rate</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Bundle Type</label>
              <select 
                value={bundleType} 
                onChange={(e) => setBundleType(e.target.value)}
                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              >
                <option value="single">Single Item</option>
                <option value="pack3">3-Pack Bundle</option>
                <option value="pack5">5-Pack Bundle</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Volume Harian</label>
              <input
                type="number"
                value={dailyVolume}
                onChange={(e) => setDailyVolume(parseInt(e.target.value) || 0)}
                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              />
            </div>
          </div>
        </div>

        {/* Key Metrics */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
          <div className="bg-white rounded-lg shadow-md p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Profit Per Unit</p>
                <p className="text-3xl font-bold text-green-600">
                  RM{calculateProfits.profitPerUnit.toFixed(2)}
                </p>
                <p className="text-sm text-gray-500">
                  Margin: {calculateProfits.marginPercent.toFixed(1)}%
                </p>
              </div>
              <DollarSign className="h-12 w-12 text-green-600" />
            </div>
          </div>

          <div className="bg-white rounded-lg shadow-md p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Daily Profit</p>
                <p className="text-3xl font-bold text-blue-600">
                  RM{volumeProjections.daily.profit.toFixed(0)}
                </p>
                <p className="text-sm text-gray-500">
                  {volumeProjections.daily.units} units
                </p>
              </div>
              <TrendingUp className="h-12 w-12 text-blue-600" />
            </div>
          </div>

          <div className="bg-white rounded-lg shadow-md p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Monthly Profit</p>
                <p className="text-3xl font-bold text-purple-600">
                  RM{volumeProjections.monthly.profit.toLocaleString()}
                </p>
                <p className="text-sm text-gray-500">
                  {volumeProjections.monthly.units.toLocaleString()} units
                </p>
              </div>
              <Target className="h-12 w-12 text-purple-600" />
            </div>
          </div>

          <div className="bg-white rounded-lg shadow-md p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Annual Profit</p>
                <p className="text-3xl font-bold text-red-600">
                  RM{volumeProjections.annual.profit.toLocaleString()}
                </p>
                <p className="text-sm text-gray-500">
                  {volumeProjections.annual.units.toLocaleString()} units
                </p>
              </div>
              <Calculator className="h-12 w-12 text-red-600" />
            </div>
          </div>
        </div>

        {/* Charts Row */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          {/* Profit Comparison Chart */}
          <div className="bg-white rounded-lg shadow-md p-6">
            <h3 className="text-lg font-semibold mb-4">üí∞ Perbandingan Profit Semua Produk</h3>
            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={chartData}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="name" angle={-45} textAnchor="end" height={80} />
                <YAxis />
                <Tooltip 
                  formatter={(value, name) => [
                    name === 'profit' ? `RM${value}` : `${value}%`,
                    name === 'profit' ? 'Profit' : 'Margin'
                  ]}
                />
                <Legend />
                <Bar dataKey="profit" fill="#10B981" name="Profit (RM)" />
              </BarChart>
            </ResponsiveContainer>
          </div>

          {/* Cost Breakdown Pie Chart */}
          <div className="bg-white rounded-lg shadow-md p-6">
            <h3 className="text-lg font-semibold mb-4">üìä Pecahan Kos - {products[selectedProduct].name}</h3>
            <ResponsiveContainer width="100%" height={300}>
              <PieChart>
                <Pie
                  data={pieData}
                  cx="50%"
                  cy="50%"
                  labelLine={false}
                  label={({ name, value }) => `${name}: RM${value.toFixed(2)}`}
                  outerRadius={80}
                  fill="#8884d8"
                  dataKey="value"
                >
                  {pieData.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                  ))}
                </Pie>
                <Tooltip formatter={(value) => `RM${value.toFixed(2)}`} />
              </PieChart>
            </ResponsiveContainer>
          </div>
        </div>

        {/* Detailed Breakdown */}
        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
          <h3 className="text-lg font-semibold mb-4">üîç Analisis Terperinci - {products[selectedProduct].name}</h3>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h4 className="font-medium text-gray-700 mb-3">Revenue Breakdown</h4>
              <div className="space-y-2">
                <div className="flex justify-between">
                  <span>Harga Jual ({calculateProfits.units} unit{calculateProfits.units > 1 ? 's' : ''})</span>
                  <span className="font-semibold">RM{calculateProfits.revenue.toFixed(2)}</span>
                </div>
                <div className="flex justify-between text-red-600">
                  <span>TikTok Fees</span>
                  <span>-RM{calculateProfits.fees.toFixed(2)}</span>
                </div>
                <div className="flex justify-between text-purple-600">
                  <span>Affiliate Commission ({affiliateRate}%)</span>
                  <span>-RM{calculateProfits.affiliate.toFixed(2)}</span>
                </div>
                <div className="flex justify-between text-orange-600">
                  <span>Product Cost</span>
                  <span>-RM{calculateProfits.productCost.toFixed(2)}</span>
                </div>
                <hr />
                <div className="flex justify-between text-green-600 font-bold">
                  <span>Net Profit</span>
                  <span>RM{calculateProfits.profit.toFixed(2)}</span>
                </div>
              </div>
            </div>

            <div>
              <h4 className="font-medium text-gray-700 mb-3">Volume Projections</h4>
              <div className="space-y-2">
                <div className="flex justify-between">
                  <span>Daily ({dailyVolume} orders)</span>
                  <span className="font-semibold">RM{volumeProjections.daily.profit.toFixed(2)}</span>
                </div>
                <div className="flex justify-between">
                  <span>Weekly (x7)</span>
                  <span className="font-semibold">RM{(volumeProjections.daily.profit * 7).toFixed(2)}</span>
                </div>
                <div className="flex justify-between">
                  <span>Monthly (x30)</span>
                  <span className="font-semibold">RM{volumeProjections.monthly.profit.toLocaleString()}</span>
                </div>
                <div className="flex justify-between">
                  <span>Annual (x365)</span>
                  <span className="font-semibold">RM{volumeProjections.annual.profit.toLocaleString()}</span>
                </div>
                <hr />
                <div className="flex justify-between text-blue-600 font-bold">
                  <span>Annual Units Sold</span>
                  <span>{volumeProjections.annual.units.toLocaleString()}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Product Comparison Table */}
        <div className="bg-white rounded-lg shadow-md p-6">
          <h3 className="text-lg font-semibold mb-4">üìã Perbandingan Lengkap Semua Produk</h3>
          
          <div className="overflow-x-auto">
            <table className="min-w-full table-auto">
              <thead>
                <tr className="bg-gray-50">
                  <th className="px-4 py-3 text-left font-medium text-gray-700">Produk</th>
                  <th className="px-4 py-3 text-right font-medium text-gray-700">Kos Default</th>
                  <th className="px-4 py-3 text-right font-medium text-gray-700">Profit/Unit</th>
                  <th className="px-4 py-3 text-right font-medium text-gray-700">Margin %</th>
                  <th className="px-4 py-3 text-right font-medium text-gray-700">Daily Profit (50 units)</th>
                  <th className="px-4 py-3 text-right font-medium text-gray-700">Monthly Profit</th>
                </tr>
              </thead>
              <tbody>
                {Object.entries(products).map(([key, product]) => {
                  const cost = product.defaultCost;
                  const netRevenue = 10 - 0.75 - (affiliateRate / 100 * 10);
                  const profit = netRevenue - cost;
                  const margin = (profit / 10) * 100;
                  const dailyProfit = profit * 50;
                  const monthlyProfit = dailyProfit * 30;
                  
                  return (
                    <tr key={key} className={selectedProduct === key ? 'bg-blue-50' : 'hover:bg-gray-50'}>
                      <td className="px-4 py-3">
                        <div className="flex items-center">
                          <span className="text-2xl mr-2">{product.emoji}</span>
                          <span className="font-medium">{product.name}</span>
                        </div>
                      </td>
                      <td className="px-4 py-3 text-right">RM{cost.toFixed(2)}</td>
                      <td className="px-4 py-3 text-right font-semibold text-green-600">
                        RM{profit.toFixed(2)}
                      </td>
                      <td className="px-4 py-3 text-right">{margin.toFixed(1)}%</td>
                      <td className="px-4 py-3 text-right font-semibold">
                        RM{dailyProfit.toFixed(2)}
                      </td>
                      <td className="px-4 py-3 text-right font-semibold text-blue-600">
                        RM{monthlyProfit.toLocaleString()}
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>

        {/* Recommendations */}
        <div className="bg-gradient-to-r from-blue-50 to-green-50 rounded-lg p-6">
          <h3 className="text-lg font-semibold mb-4">üí° Recommendations untuk {products[selectedProduct].name}</h3>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <h4 className="font-medium text-green-700 mb-2">‚úÖ Keunggulan</h4>
              <ul className="text-sm space-y-1 text-gray-700">
                <li>‚Ä¢ Margin profit tinggi: {calculateProfits.marginPercent.toFixed(1)}%</li>
                <li>‚Ä¢ Customer bayar shipping sendiri</li>
                <li>‚Ä¢ Sustainable business model</li>
                <li>‚Ä¢ Flexibility dalam bundle pricing</li>
              </ul>
            </div>
            
            <div>
              <h4 className="font-medium text-orange-700 mb-2">‚ö†Ô∏è Pertimbangan</h4>
              <ul className="text-sm space-y-1 text-gray-700">
                <li>‚Ä¢ Customer total payment: RM13-16</li>
                <li>‚Ä¢ Perlu value proposition yang kuat</li>
                <li>‚Ä¢ Kompetisi dengan free shipping</li>
                <li>‚Ä¢ Monitor conversion rate closely</li>
              </ul>
            </div>
          </div>
          
          <div className="mt-4 p-4 bg-white rounded-lg">
            <p className="text-center font-semibold text-gray-800">
              üéØ Target: {dailyVolume} orders/hari = RM{volumeProjections.monthly.profit.toLocaleString()} profit/bulan
            </p>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ProductDashboard;
